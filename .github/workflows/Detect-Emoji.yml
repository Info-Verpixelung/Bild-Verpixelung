name: Block Emojis in Code Files

on:
  pull_request:
    branches: ["**"]

jobs:
  emoji-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed .py and .js files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            | grep -E '\.(py|js)$' || true)

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Scan for emojis in executable code
        run: |
          FILES="${{ steps.changed-files.outputs.files }}"

          if [ -z "$FILES" ]; then
            echo "No changed .py or .js files."
            exit 0
          fi

          python3 << 'EOF'
import sys
import re
import tokenize
from io import BytesIO
import pathlib

EMOJI_PATTERN = re.compile(r'[\U0001F300-\U0001FAFF\u2600-\u27BF]')
files = """${{ steps.changed-files.outputs.files }}""".strip().splitlines()

found = False


def scan_python(path):
    global found
    content = path.read_bytes()
    tokens = tokenize.tokenize(BytesIO(content).readline)

    for token in tokens:
        if token.type in (tokenize.COMMENT, tokenize.STRING, tokenize.ENCODING):
            continue

        if EMOJI_PATTERN.search(token.string):
            print(f"âŒ Emoji found in Python code: {path} (line {token.start[0]})")
            found = True


def strip_js_comments_and_strings(code):
    result = []
    i = 0
    length = len(code)

    while i < length:
        # Single-line comment //
        if code[i:i+2] == "//":
            i += 2
            while i < length and code[i] != "\n":
                i += 1

        # Multi-line comment /* */
        elif code[i:i+2] == "/*":
            i += 2
            while i < length-1 and code[i:i+2] != "*/":
                i += 1
            i += 2

        # String literals
        elif code[i] in ('"', "'", "`"):
            quote = code[i]
            i += 1
            while i < length:
                if code[i] == "\\":
                    i += 2
                elif code[i] == quote:
                    i += 1
                    break
                else:
                    i += 1
        else:
            result.append(code[i])
            i += 1

    return "".join(result)


def scan_js(path):
    global found
    code = path.read_text(encoding="utf-8", errors="ignore")
    stripped = strip_js_comments_and_strings(code)

    for lineno, line in enumerate(stripped.splitlines(), start=1):
        if EMOJI_PATTERN.search(line):
            print(f"âŒ Emoji found in JavaScript code: {path} (line {lineno})")
            found = True


for file_path in files:
    path = pathlib.Path(file_path)

    try:
        if path.suffix == ".py":
            scan_python(path)
        elif path.suffix == ".js":
            scan_js(path)
    except Exception as e:
        print(f"Error processing {file_path}: {e}")

if found:
    print("ðŸš¨ Emojis are not allowed in executable code.")
    sys.exit(1)
else:
    print("âœ… No emojis found in executable code.")
EOF
